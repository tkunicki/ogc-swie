<?xml version="1.0" encoding="UTF-8" ?>
 <!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="wfsMapper">

	<resultMap id="wfsBaseMap" type="XMLMap">
		<result
	    	property="wfs:FeatureCollection"
	    	column="%ROOT_ELEMENT"
			javaType="string" />
	    <result
	    	property="xmlns:wfs=http://www.opengis.net/wfs"
	    	column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
	    <result
	    	property="xmlns:gml=http://www.opengis.net/gml"
	    	column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
		<result
	    	property="xmlns:gsml=urn:cgi:xmlns:CGI:GeoSciML:2.0"
	    	column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
	    <result
	    	property="xmlns:gwml=http://www.nrcan.gc.ca/xml/gwml/1"
	    	column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
		<result
	    	property="xmlns:om=http://www.opengis.net/om/1.0"
	    	column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
		<result
	    	property="xmlns:sa=http://www.opengis.net/sampling/1.0"
	    	column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
		<result
    		property="xmlns:xlink=http://www.w3.org/1999/xlink"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
		<result
    		property="xmlns:xs=http://www.w3.org/2001/XMLSchema"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
		<result
    		property="xmlns:xsi=http://www.w3.org/2001/XMLSchema-instance"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
		<result
    		property="xsi:schemaLocation=http://www.opengis.net/om/1.0 http://schemas.opengis.net/om/1.0.0/om.xsd"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
	</resultMap>
	
	<resultMap id="wfsResultMap" type="XMLMap" extends="wfsBaseMap">
	 	<id
	 		property="^!{gml:featureMember"
	 		column="id"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell#gml:id"
			column="id"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/^gml:name#codeSpace=http://cida.xxx.gov/station_nm/"
			column="station_nm"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gml:name"
			column="station_nm"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/^gml:name#codeSpace=urn:gov.usgs.nwis.agency_cd_site_no"
			column="id"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gml:name"
			column="id"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gml:boundedBy/gml:envelope#srsName=EPSG:4326"
			column="long_lat"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gml:boundedBy/gml:envelope/gml:pos#srsDimension=2"
			column="long_lat"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gml:boundedBy/gml:envelope/gml:pos"
			column="long_lat"
			javaType="string" />
			
		<association property="UNUSED" column="site_no" select="wfsRelatedObservationSelect" javaType="list" />
			
		<result
			property="gml:featureMember/gwml:WaterWell/sa:position/gml:Point#srsName=EPSG:4326"
			column="long_lat_alt"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/sa:position/gml:Point/gml:pos"
			column="long_lat_alt"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:referenceElevation#uom=urn:ogc:def:uom:UCUM:ft_i"
			column="alt"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:referenceElevation"
			column="alt"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/^gwml:wellDepth/gsml:CGI_NumericValue/gsml:principalValue#uom=urn:ogc:def:uom:UCUM:ft_i"
			column="well_depth_va"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:wellDepth/gsml:CGI_NumericValue/gsml:principalValue"
			column="well_depth_va"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/^gwml:wellStatus/gsml:CGI_TermValue/gsml:value#codeSpace=urn:gov.usgs.nwis.alt_datum_cd"
			column="alt_datum_cd"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:wellStatus/gsml:CGI_TermValue/gsml:value"
			column="alt_datum_cd"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/^gwml:wellType/gsml:CGI_TermValue/gsml:value#codeSpace=urn:gov.usgs.nwis.nat_water_use_cd"
			column="nat_water_use_name"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:wellType/gsml:CGI_TermValue/gsml:value"
			column="nat_water_use_name"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:onlineResource#xlink:href=http://waterdata.usgs.gov/nwis/inventory?search_site_no=%s&amp;search_site_no_match_type=exact&amp;sort_key=site_no&amp;group_key=NONE&amp;sitefile_output_format=html_table&amp;column_name=agency_cd&amp;column_name=site_no&amp;column_name=station_nm&amp;format=station_manuscript&amp;list_of_search_criteria=search_site_no"
			column="site_no"
			javaType="string" />
		<result
			property="}gml:featureMember/gwml:WaterWell/gwml:onlineResource#xlink:title=USGS NWIS Database"
			column="site_no"
			javaType="string" />
		
		<collection property="UNUSED" column="site_no" select="wfsLogElementSelect" javaType="list" />
			
	</resultMap>
	
	<resultMap id="wfsRelatedObservationResultMap" type="XMLMap">
		<id
			property="gml:featureMember/gwml:WaterWell/sa:relatedObservation/^om:Observation#gml:id"
			column="WATERLEVEL_ID"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/sa:relatedObservation/om:Observation/gml:description=Test Yield"
			column="WATERLEVEL_ID"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/sa:relatedObservation/om:Observation/gml:name#codeSpace=urn:x-ngwd:ab:WaterLevel"
			column="WATERLEVEL_ID"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/sa:relatedObservation/om:Observation/gml:name"
			column="WATERLEVEL_ID"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/sa:relatedObservation/om:Observation/om:samplingTime/gml:TimeInstant/gml:position"
			column="disc_dt"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/sa:relatedObservation/om:Observation/om:procedure#xlink:href=urn:x-ngwd:procedure:unknown"
			column="WATERLEVEL_ID"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/sa:relatedObservation/om:Observation/om:observedProperty#xlink:href=urn:x-ngwd:def:phenomenon:OGC:WellYield"
			column="WATERLEVEL_ID"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/sa:relatedObservation/om:Observation/om:featureOfInterest#xlink:href"
			column="ID"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/sa:relatedObservation/om:Observation/om:result#xsi:type=gml:MeasureType"
			column="disc_va"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/sa:relatedObservation/om:Observation/om:result#uom=urn:x-ngwd:def:uom:gpm_f"
			column="disc_va"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/sa:relatedObservation/om:Observation/om:result"
			column="disc_va"
			javaType="string" />
	</resultMap>
	
	<resultMap id="wfsLogElementResultMap" type="XMLMap">
		<id
			property="gml:featureMember/gwml:WaterWell/^gwml:logElement/gsml:MappedInterval/gsml:observationMethod/gsml:CGI_TermValue/gsml:value#codeSpace=urn:x-ngwd:classifier:GIN:ObservationMethod"
			column="HYDROSTRUNIT_ID"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:observationMethod/gsml:CGI_TermValue/gsml:value=borehole"
			column="HYDROSTRUNIT_ID"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:specification/gwml:HydrostratigraphicUnit#gml:id"
			column="HYDROSTRUNIT_ID"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:specification/gwml:HydrostratigraphicUnit/gml:description"
			column="LITH_NAME"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:specification/gwml:HydrostratigraphicUnit/gsml:observationMethod/gsml:CGI_TermValue/gsml:value#codeSpace=urn:x-ngwd:classifier:GIN:ObservationMethod"
			column="HYDROSTRUNIT_ID"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:specification/gwml:HydrostratigraphicUnit/gsml:observationMethod/gsml:CGI_TermValue/gsml:value=borehole"
			column="HYDROSTRUNIT_ID"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:specification/gwml:HydrostratigraphicUnit/gsml:purpose=instance"
			column="HYDROSTRUNIT_ID"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:specification/gwml:HydrostratigraphicUnit/gsml:composition/gsml:CompositionPart/gsml:role#codeSpace=urn:x-ngwd:classifier:GIN:Role"
			column="LITH_NAME"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:specification/gwml:HydrostratigraphicUnit/gsml:composition/gsml:CompositionPart/gsml:role=contains"
			column="LITH_NAME"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:specification/gwml:HydrostratigraphicUnit/gsml:composition/gsml:CompositionPart/gsml:lithology/gsml:ControlledConcept/gml:name#codeSpace=urn:x-ngwd:classifierScheme:USGS:Lithology:2010"
			column="LITH_NAME"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:specification/gwml:HydrostratigraphicUnit/gsml:composition/gsml:CompositionPart/gsml:lithology/gsml:ControlledConcept/gml:name#xml:lang=eng"
			column="LITH_NAME"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:specification/gwml:HydrostratigraphicUnit/gsml:composition/gsml:CompositionPart/gsml:lithology/gsml:ControlledConcept/gml:name"
			column="LITH_NAME"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:specification/gwml:HydrostratigraphicUnit/gsml:composition/gsml:CompositionPart/gsml:material/gsml:UnconsolidatedMaterial/gml:name"
			column="LITH_NAME"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:specification/gwml:HydrostratigraphicUnit/gsml:composition/gsml:CompositionPart/gsml:material/gsml:UnconsolidatedMaterial/gsml:purpose=instance"
			column="LITH_NAME"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:specification/gwml:HydrostratigraphicUnit/gsml:composition/gsml:CompositionPart/gsml:proportion/gsml:CGI_TermValue/gsml:value#codeSpace=urn:ietf:rfc:2141"
			column="LITH_NAME"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:specification/gwml:HydrostratigraphicUnit/gsml:composition/gsml:CompositionPart/gsml:proportion/gsml:CGI_TermValue/gsml:value=urn:ogc:def:nil:OGC:unknown"
			column="LITH_NAME"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:shape/gml:LineString#srsDimension=1"
			column="LITH_TOP_BOTTOM"
			javaType="string" />
		<result
			property="gml:featureMember/gwml:WaterWell/gwml:logElement/gsml:MappedInterval/gsml:shape/gml:LineString/gml:coordinates"
			column="LITH_TOP_BOTTOM"
			javaType="string" />
	</resultMap>
	
	<select id="wfsSelect" parameterType="map" resultMap="wfsResultMap" fetchSize="1024" useCache="false" resultSetType="FORWARD_ONLY">
		SELECT DISTINCT
			s.agency_cd||'.'||s.site_no AS id,
			s.site_no as site_no,
			TRIM(s.station_nm) as station_nm,
			s.dec_long_va||' '||s.dec_lat_va AS long_lat,
			s.dec_long_va||' '||s.dec_lat_va||' '||s.alt_va AS long_lat_alt,
			s.alt_va AS alt,
			s.alt_datum_cd,
			s.well_depth_va,
			s.nat_water_use_name
		FROM
			nwis_dwh_star.sites_gw_mvw s
		WHERE 1 = 0
		<trim prefix="OR (" suffix=")" prefixOverrides="AND">
			<if test="bBox != null">
		AND s.dec_long_va BETWEEN #{bBox[0]} AND #{bBox[2]} AND s.dec_lat_va BETWEEN #{bBox[1]} AND #{bBox[3]} 
			</if>
			<if test="featureId != null">
		AND SUBSTR(#{featureId}, 1, INSTR(#{featureId}, '.') - 1) = s.agency_cd
		AND SUBSTR(#{featureId}, INSTR(#{featureId}, '.') + 1) = s.site_no
			</if>
			<if test="maxFeatures != null">
		AND ROWNUM<![CDATA[ <= ]]> #{maxFeatures}
			</if>
		</trim>	
	    ORDER BY
			station_nm
	</select>
	
	<select id="wfsLogElementSelect" parameterType="map" resultMap="wfsLogElementResultMap" fetchSize="1024" useCache="false" resultSetType="FORWARD_ONLY">
		SELECT DISTINCT
    		b.AGENCY_CD||'.'||b.SITE_NO||'.'||b.GEOH_SEQ_NU AS HYDROSTRUNIT_ID,
			b.LITH_NAME,
			TRIM(b.LITH_TOP_VA)||' '||TRIM(b.LITH_BOTTOM_VA) AS LITH_TOP_BOTTOM,
			b.LITH_TOP_VA
		FROM
			NWIS_DWH_STAR.GW_SITE_DETAIL b
		INNER JOIN ( 
			SELECT DISTINCT
				CD,
				DESCR
			FROM
				NWIS_DWH_STAR.MYCODES
			WHERE
				WHICH = 'LITH_CD') c ON b.LITH_CD = c.CD
		WHERE 
			b.SITE_NO = #{site_no}
		AND
			b.LITH_TOP_VA IS NOT NULL
		AND
			b.LITH_BOTTOM_VA IS NOT NULL
		ORDER BY
			b.LITH_TOP_VA
	</select>
	
	<select id="wfsRelatedObservationSelect" parameterType="map" resultMap="wfsRelatedObservationResultMap" fetchSize="1024" useCache="false" resultSetType="FORWARD_ONLY">
		SELECT DISTINCT
			b.AGENCY_CD||'.'||b.SITE_NO AS ID,
			b.AGENCY_CD||'.'||b.SITE_NO||'.YLD.'||b.DISC_SEQ_NU AS WATERLEVEL_ID,
			b.DISC_SEQ_NU,
			b.DISC_DT
		FROM
			NWIS_DWH_STAR.GW_SITE_DETAIL b
		WHERE
		 	b.SITE_NO = #{site_no}
		AND 
		    b.DISC_SEQ_NU IS NOT NULL
		ORDER BY
			b.DISC_SEQ_NU
	</select>
	

</mapper> 
