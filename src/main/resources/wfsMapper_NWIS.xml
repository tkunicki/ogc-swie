<?xml version="1.0" encoding="UTF-8" ?>
 <!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="wfsMapper_NWIS">

	<resultMap id="wfsBaseMap" type="XMLMap">
		<result
	    	property="wfs:FeatureCollection"
	    	column="%ROOT_ELEMENT"
			javaType="string" />
	    <result
	    	property="xmlns:wfs=http://www.opengis.net/wfs/2.0"
	    	column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
	    <result
	    	property="xmlns:gml=http://www.opengis.net/gml/3.2"
	    	column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
		<result
	    	property="xmlns:gsml=urn:cgi:xmlns:CGI:GeoSciML:2.0"
	    	column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
<!-- Not sure what should go here yet-->
            <result
	    	property="xmlns:swml=http://www.nrcan.gc.ca/xml/swml/1"
	    	column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
		<result
	    	property="xmlns:om=http://www.opengis.net/om/2.0"
	    	column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
		<result
	    	property="xmlns:sa=http://www.opengis.net/sampling/2.0"
	    	column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
		<result
    		property="xmlns:xlink=http://www.w3.org/1999/xlink"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
		<result
    		property="xmlns:xs=http://www.w3.org/2001/XMLSchema"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
		<result
    		property="xmlns:xsi=http://www.w3.org/2001/XMLSchema-instance"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
            <result
    		property="xmlns:wml2=http://www.opengis.net/waterml/2.0"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
            <result
    		property="xmlns:sf=http://www.opengis.net/sampling/2.0"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
            <result
    		property="xmlns:sams=http://www.opengis.net/samplingSpatial/2.0"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
<!-- Dynamic Root attributes? -->
                <result
    		property="timeStamp=2011-11-11"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
  <!--              <result
    		property="timeStamp=%s"
    		column="currentPosition"
			javaType="string" />
 -->
                <result
    		property="numberMatched=1"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
                <result
    		property="numberReturned=1"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />

                <result
    		property="xsi:schemaLocation= http://www.opengis.net/om/2.0 ../observation.xsd
http://www.opengis.net/gml/3.2 http://schemas.opengis.net/gml/3.2.1/gml.xsd
http://www.opengis.net/sampling/2.0 ../samplingFeature.xsd
http://www.opengis.net/waterml/2.0 ../waterml2.xsd
http://www.opengis.net/swe/2.0 http://schemas.opengis.net/sweCommon/2.0/swe.xsd"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
<!--
                <result
    		property="xsi:schemaLocation=http://www.opengis.net/om/1.0 http://schemas.opengis.net/om/1.0.0/om.xsd"
    		column="%ROOT_ELEMENT_ATTRIBUTE"
			javaType="string" />
-->
	</resultMap>
	
	<resultMap id="wfsResultMap" type="XMLMap" extends="wfsBaseMap">
 <!--
                 <id
	 		property="^!{wfs:boundedBy"
	 		column="FEATURE_ID"
			javaType="string" />
-->
                <result
			property="^!{wfs:boundedBy/gml:Envelope#srsName=urn:ogc:def:crs:EPSG::4326"
			column="Constant"
			javaType="string" />

<!-- TODO: get a dynamic bounding box-->
                <result
			property="wfs:boundedBy/gml:Envelope/gml:lowerCorner"
			column="lower"
			javaType="string" />
		<result
			property="wfs:boundedBy/gml:Envelope/gml:upperCorner"
			column="upper"
			javaType="string" />
		<result
			property="}^!{wfs:member/om:featureOfInterest/^gml:name"
			column="station_nm"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/gml:name"
			column="station_nm"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/^wml2:WaterMonitoringPoint#gml:id=%s"
			column="site_no"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/wml2:WaterMonitoringPoint/^sf:sampledFeature#xlink:ref=%s"
			column="state_site"
			typeHandler="StateCodeTypeHandler" />
		<result
			property="wfs:member/om:featureOfInterest/wml2:WaterMonitoringPoint/sams:shape/^gml:Point#gml:id=st1p"
			column="STATION_NM"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/wml2:WaterMonitoringPoint/sams:shape/gml:Point/^gml:pos#srsName=urn:ogc:def:crs:EPSG:4326"
			column="LON_LAT"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/wml2:WaterMonitoringPoint/sams:shape/gml:Point/gml:pos"
			column="LON_LAT"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/wml2:WaterMonitoringPoint/^wml2:descriptionReference#xlink:href=http://external.opengis.org/twiki_public/bin/view/HydrologyDWG/SurfacewaterInteroperabilityExperiment#Use_Case_2"
			column="FEATURE_ID"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/wml2:WaterMonitoringPoint/wml2:descriptionReference#xlink:title=This wiki page describes the IE"
			column="FEATURE_ID"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/wml2:timeZone/wml2:TimeZone/^wml2:zoneOffset"
			column="currentPosition"
			typeHandler="TimeZoneTypeHandler" />
		<result
			property="}wfs:member/om:featureOfInterest/wml2:timeZone/wml2:TimeZone/^wml2:zoneAbbreviation"
			column="tz_cd"
			javaType="string" />

        <!-- removed per NLB 05.24.2010, will be put back in later but still needs output validation... -->
		<!--<association property="UNUSED" column="FEATURE_ID" select="wfsRelatedObservationSelect" javaType="list" />-->
<!--
		<result
			property="wfs:member/om:featureOfInterest/sa:position/gml:Point#srsName=EPSG:4326"
			column="LON_LAT_ALT"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/sa:position/gml:Point/gml:pos"
			column="LON_LAT_ALT"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/swml:referenceElevation#uom=urn:ogc:def:uom:UCUM:ft_i"
			column="ALT"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/swml:referenceElevation"
			column="ALT"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/^swml:wellDepth/gsml:CGI_NumericValue/gsml:principalValue#uom=urn:ogc:def:uom:UCUM:ft_i"
			column="WELL_DEPTH_VA"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/swml:wellDepth/gsml:CGI_NumericValue/gsml:principalValue"
			column="WELL_DEPTH_VA"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/^swml:wellStatus/gsml:CGI_TermValue/gsml:value#codeSpace=urn:gov.usgs.nwis.alt_datum_cd"
			column="ALT_DATUM_CD"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/swml:wellStatus/gsml:CGI_TermValue/gsml:value"
			column="ALT_DATUM_CD"
			javaType="string" />
                <result
			property="wfs:member/om:featureOfInterest/^swml:wellStatus/gsml:CGI_TermValue/gsml:value#codeSpace=urn:gov.usgs.nwis.state_cd"
			column="STATE_CD"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/swml:wellStatus/gsml:CGI_TermValue/gsml:state_cd"
			column="STATE_CD"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/^swml:wellType/gsml:CGI_TermValue/gsml:value#codeSpace=urn:gov.usgs.nwis.nat_water_use_cd"
			column="NAT_WATER_USE_CD"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/swml:wellType/gsml:CGI_TermValue/gsml:value"
			column="NAT_WATER_USE_CD"
			javaType="string" />
		<result
			property="wfs:member/om:featureOfInterest/swml:onlineResource#xlink:href=%s"
			column="state_site"
			typeHandler="StateCodeTypeHandler" />
		<result
			property="}wfs:member/om:featureOfInterest/swml:onlineResource#xlink:title=USGS NWIS Database"
			column="state_site"
			javaType="string" />
-->
		
		<!-- association property="UNUSED" column="FEATURE_ID" select="wfsLogElementSelect" javaType="list" />
		<association property="UNUSED" column="FEATURE_ID" select="wfsScreenElementSelect" javaType="list" /-->
	</resultMap>

	<select id="wfsSelect_NWIS" parameterType="map" resultMap="wfsResultMap" fetchSize="1024" useCache="false" resultSetType="FORWARD_ONLY">
		SELECT a.site_no AS SITE_NO, 
		a.agency_cd,
		CONCAT(a.agency_cd,'.', a.site_no) as FEATURE_ID,
		a.station_nm AS STATION_NM,
		CONCAT(CONVERT(a.dec_lat_va,CHAR),' ',CONVERT(a.dec_long_va,CHAR)) AS LON_LAT, 
		CONCAT(CONVERT(a.dec_lat_va,CHAR),' ',CONVERT(a.dec_long_va,CHAR),' ',CONVERT(a.alt_va,CHAR)) AS LON_LAT_ALT,
		a.alt_va AS ALT,
		a.ALT_DATUM_CD,
		a.WELL_DEPTH_VA,
		a.NAT_WATER_USE_CD,
                a.STATE_CD,
                CONCAT(a.state_cd,'.',a.site_no) as state_site,
                CONCAT(DATE_FORMAT(SYSDATE(),'%Y-%m-%dT%H:%i'),a.tz_cd) as currentPosition,
                'test' as Constant,
                a.tz_cd,
                s.lowerPosition AS lower,
                s.upperPosition AS upper

		FROM (           
                    <choose>
                        
                        <when test="bBox != null">
                             SELECT b.site_no,
                             CONCAT(#{bBox[0]},' ', #{bBox[1]}) as lowerPosition,
                             CONCAT(#{bBox[2]},' ', #{bBox[3]}) as upperPosition
                             FROM nwisweb.SITEFILE b
                             WHERE b.site_no = '01446500'
                        </when>
                        
                        <otherwise>
                            SELECT b.site_no,
                            CONCAT(MAX(b.dec_lat_va),' ',MIN(b.dec_long_va)) as lowerPosition,
                            CONCAT(MIN(b.dec_lat_va),' ',MAX(b.dec_long_va)) as upperPosition
                            FROM nwisweb.SITEFILE b
                            <choose>
                                <when test="featureId != null">
                                    WHERE #{featureId} = b.site_no
                                </when>

                                <otherwise>
                                    WHERE b.site_no IN (
                                    '01427207','01427510','01434000','01438500','01446775','01446776',
                                    '01457500','01463500','04073365','04073500','04082400','04084445','040851385',
                                    '05344500','05378500','05389500','05391000','05395000','05404000','05407000',
                                    '05420500','05543500','05543830','05545750','05551540','05552500','05558300',
                                    '05568500','05585500','05586100','07010000','07020500','07022000','05030500',
                                    '05046000','05046475','05049000','05050000','05051300','05051500',
                                    '05054000','05061000','05061500','05062000','05062500','05063398','05064000',
                                    '05064500','05067500','05069000','05074500','05075000','05076000','05078000',
                                    '05078230','05078500','05078720','05078770','05079000','05080000','05082500',
                                    '05083500','05085450','05087500','05092000','05094000','05104500','05106000',
                                    '05107500','05112000'
                                    )
                                </otherwise>
                            </choose>
                        </otherwise>

                      </choose>                             
                ) s,

                nwisweb.SITEFILE a
               <!-- WHERE 1 = 0-->

              <choose>
                    <when test="featureId != null">
                        WHERE #{featureId} = a.site_no
                    </when>
                    
                    <when test="bBox != null">
                        WHERE a.dec_long_va BETWEEN #{bBox[0]} AND #{bBox[2]} AND a.dec_lat_va BETWEEN #{bBox[1]} AND #{bBox[3]} 
                    </when>

                    <otherwise>
                        WHERE a.site_no IN (
                            '01427207','01427510','01434000','01438500','01446775','01446776',
                            '01457500','01463500','04073365','04073500','04082400','04084445','040851385',
                            '05344500','05378500','05389500','05391000','05395000','05404000','05407000',
                            '05420500','05543500','05543830','05545750','05551540','05552500','05558300',
                            '05568500','05585500','05586100','07010000','07020500','07022000','05030500',
                            '05046000','05046475','05049000','05050000','05051300','05051500',
                            '05054000','05061000','05061500','05062000','05062500','05063398','05064000',
                            '05064500','05067500','05069000','05074500','05075000','05076000','05078000',
                            '05078230','05078500','05078720','05078770','05079000','05080000','05082500',
                            '05083500','05085450','05087500','05092000','05094000','05104500','05106000',
                            '05107500','05112000')
                    </otherwise>
                </choose>

<!---		<trim prefix="OR (" suffix=")" prefixOverrides="AND">
			<if test="bBox != null">
                            AND a.DEC_LONG_VA BETWEEN #{bBox[0]} AND #{bBox[2]} AND a.DEC_LAT_VA BETWEEN #{bBox[1]} AND #{bBox[3]}
			</if>
			<if test="featureId != null">
                            AND a.site_no = #{featureId[0]}
			</if>
			<if test="maxFeatures != null">
                            AND ROWNUM<![CDATA[ <= ]]> #{maxFeatures}
			</if>
		</trim>
-->
	</select>
</mapper> 

